# Проектная работа "Веб-ларек"

[Ссылка на репозиторий](https://github.com/andrabra/web-larek-frontend)

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с TS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных используемые в приложении

Карточка товара

```
export interface ICard {
	_id: string;
	description: string;
	image: string;
	title: string;
	category: string;
	price: number | null;
	inBasket: boolean;
}
```

Данные заказа для оплаты

```
export interface IOrder {
	methodOfPayment: TPayment;
	address: string;
	email: string;
	phone: string;
	items: string[];
}
```

Интерфейс для хранения модели данных карточек

```
export interface ICardsData {
	products: ICard[];
	preview: string | null;
	getProduct(id: string): ICard | undefined;
}
```

Интерфейс для корзины

```
export interface IBasket {
	purchases: ICard[];
	addPurchase(value: ICard): void;
	deletePurchase(id: string): void;
	getQuantity(): number;
	checkProduct(id: string): boolean;
	getTotal(): number;
	getIdList(): string[];
	clear(): void;
}
```

Данные, используемые при открытии корзины

```
export type TModalBasket = Pick<ICard, 'title' | 'price'>;
```

Данные, используемые при открытии модального окна со способом оплаты и адресом

```
export type TModalFormOfPayment = Pick<
	ICustomer,
	'methodOfPayment' | 'address'
>;
```

Данные используемые при открытии модального окна с контактной информацией

```
export type TModalContacts = Pick<ICustomer, 'email' | 'phone'>;
```

Данные, используемые при открытии модального окна с корзиной

```
export type TModalSuccess = Pick<IBasket, 'getQuantity'>;
```

Тип оплаты

```
export type TPayment = 'card' | 'cash';
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:

- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Конструктор:

- `constructor(baseUrl: string, options: RequestInit = {})`- принимает базовый URL и глобальные опции для всех запросов(опционально)
  Методы:
- `handleResponse(response: Response): Promise<object>` - обрабатывает ответа с сервера. Если ответ с сервера пришел, то возвращается его в формате json, в противном случае формирует ошибку
- `get(uri: string): Promise<object>` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post(uri: string, data: object, method: ApiPostMethods = 'POST'): Promise<object>` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.\

Поля:

- `_events: Map<EventName, Set<Subscriber>>` - хранит события
  Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on<T extends object>(event: EventName, callback: (data: T) => void): void` - подписка на событие
- `emit<T extends object>(event: string, data?: T): void` - инициализация события
- `trigger<T extends object>(event: string, context?: Partial<T>): (data: T) => void` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие
- `onAll(callback: (event: EmitterEvent) => void)` - подписка на все события
- `offAll()` - для сброса событий

### Слой данных - Model

#### Класс Model
Абстрактный базовый класс, шаблон для классов данных.
Конструктор класса принимает инстант брокера событий и объект содержащий данные модели. Используется `Partial<T>`, чтобы разрешить частичное заполнение данных.
- `constructor(data: Partial<T>, protected events: IEvents)`

Так же класс предоставляет набор методов для взаимодействия с этими данными.
`emitChanges`
`emitChanges(event: string, payload?: object)`

- `event:` Имя события, которое будет сгенерировано.
- `payload:` Дополнительные данные, которые будут переданы вместе с событием (необязательно).
Этот метод используется для оповещения всех подписчиков о том, что модель изменилась.

#### Класс CardsData

Расширяет класс Model. Класс отвечает за хранение и логику работы с каталогом товаров(карточек).\
Конструктор класса принимает инстант брокера событий.

- `constructor(events: IEvents)`

В полях класса хранятся следующие данные:

- `protected _cards: IProduct[]` - массив объектов карточек.
- `protected _preview: string | null;` - id карточки, выбранной для просмотра в модальном окне.
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `getCard(cardId: string): IProduct | undefined` - параметром принимает id карточки и возвращает карточку, соответствующую переданному id.
- `set cards(value: IProduct[]): void` - записывает массив товаров.
- `get cards(): IProduct[]` - возвращает массив товаров.
- `get preview(): string | null` - возвращает выбранную карточку товара.

#### Класс BasketData

Класс отвечает за логику и хранение данных товаров, добавленных в корзину.\
Конструктор класса принимает инстант брокера событий.

`constructor(events: IEvents)`

В полях класса хранятся следующие данные:

- `protected _purchases: IProduc[]` - коллекция товаров в корзине
- `protected _total: number` - итоговая стоимость товаров в корзине
- `events: IEvents` - экземпляр класса EventEmitter для инициации событий при изменении данных

Также в классе содержатся методы для работы с данными объекта, который формирует класс

- `addPurchase(product: IProduct): void` - добавляет товар в начало списка в корзине.
- `deletePurchase(id: string): void` - удаляет товар из корзины
- `getQuantity(): number` - возвращает общее количество товаров в корзине.
- `clearBasket(): void` - очищать корзину.
- `getTotal(): number` - устанавливает итоговую стоимость.
- `getIdList(): string[]` - для получения списка товаров в корзине по уникальному идентификатору.
- `get total(value: number): void` - получение общей суммы заказа.

#### Класс OrderData
Класс отвечает за хранение и логику работы с данными заказа.\
Конструктор класса принимает инстант брокера событий.
- `constructor(events: IEvents)`

В полях класса хранятся следующие данные:
- `_paymentInfo: TModalFormOfPayment` - платежная информация
- `_contactInfo: TModalContacts` - контактная информация
- `order: IOrder` - заказ
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- `getOrderData(): IOrder`- для получения данных о заказе
- `clearOrder(): void` - очищает данные о способе оплаты и адресе
- `clearUserContacts(): void` - очищает контактные данные покупателя
- `checkValidation(): boolean` - проверяет данные заказа

Также в классе содержатся методы для работы с данными объекта, который формирует класс:
 - `set paymentInfo(info: TModalFormOfPayment): void` - запись платежной информации
 - `get paymentInfo(): TModalFormOfPayment` - возвращает данные о способе оплаты и адресе
 - `set contactInfo(info: TModalContacts): void` - запись контактной информации
 - `get contactInfo(): TModalContacts` - возвращает контактную информаци

### Слой представления - View
#### Класс View
Абстрактный класс View является дженериком и служит шаблоном для классов слоя представления

Поля:

- `protected _container: HTMLElement` - DOM элемент, передаваемый в конструкторе
- `protected events: IEvents` - объект класса EventEmitter для инициации событий при изменении данных.

Параметры в конструкторе:

- `container: HTMLElement` - DOM элемент компонента
- `events: IEvents` - объект класса EventEmitter для инициации событий при изменении данных.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `render(data?: Partial<T>): HTMLElement` - возвращает отрисованный html элемент по переданным данным

#### Класс Card
Расширяет класс View. Является абстрактным классом, имеющим общие поля у трех разновидностей карточек в приложении:
1. карточка в каталоге на главной странице (CardCatalog);
2. карточка подробного описания товара в модальном окне (CardPreview);
3. строка с товаром в корзине (CardBasket).

Поля:

- `protected _id: string` - id карточки товара
- `protected _title: HTMLHeadingElement` - HTML элемент, отвечающий за отображение имени товара
- `protected _price: HTMLSpanElement` - html элемент, отвечающий за отображение цены товара.

Параметры в конструкторе:

- параметры `View`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `set id(value: string): void` - запись id карточки товара
- `get id(): string` - получение id карточки товара
- `set title(value: string): void` - запись имени карточки товара
- `get title(): string` - получение имени карточки товара
- `set price(value: string): void` - запись цены товара
- `get price(): string` - получение цены товара.

#### Класс CardCatalog
Расширяет класс Card, также является классом дженериком. Служит для отображения карточки в каталоге на главной странице приложения.

Поля:

- `protected _image: HTMLImageElemen`t - html элемент, отвечающий за отображение изображения товара
- `protected _category: HTMLSpanElement` - html элемент, отвечающий за отображение категории товара.
Параметры в конструкторе:

параметры `Card`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `protected addCSSClassCategory(value: string): void` - служебный метод, предназначенный для присваивания определенного css класса html элементу категории товара в зависимости от ее названия (установка фонового цвета)
- `set image(src: string): void` - запись данных изображения товара
- `set category(value: string): void` - запись данных категории товара
- `get category(): string` - получение названия категории товара.

#### Класс CardPreview
Расширяет класс CardCatalog. Служит для предварительного просмотра карточки товара с более детальным описанием и возможностью добавления его в корзину.

Поля:

- `protected _description: HTMLParagraphElement` - html элемент, отвечающий за отображение описания товара
- `protected buttonBuyDelete: HTMLButtonElement` - кнопка для покупки товара или удаления товара из корзины в случае, если он уже был добавлен в нее.

Параметры в конструкторе:

параметры класса `CardCatalog`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `set description(value: string): void` - записвает описание товара
- `set priceCheck(value: boolean): void` - записывает булево значение для блокировки/разблокировки кнопки добавления в корзину, если в модальном окне открыт бесценный товар: true - блокирует кнопку, false - разблокирует кнопку
- `get priceCheck(): boolean` - возвращает булево значение для блокировки/разблокировки кнопки добавления в корзину
- `set state(value: boolean)` - устанавливает состояние кнопки:
1. в модальном окне открыт бесценный товар - кнопка заблокирована и ей присвоена надпись "Не продается"
2. в модальном окне открыт товар, который уже находится в корзине - кнопка работает на удаление данного товара из корзины и ей присвоена надпись "Убрать из корзины"
3. в модальном окне открыт товар, которого нет в корзине - кнопка работает на добавление данного товара в корзину и ей присвоена надпись "Купить".

#### Класс CardBasket
Расширяет класс Card. Служит для отображения карточки товара в корзине.

Поля:

- `_index: HTMLSpanElement` - html элемент, отвечающий за отображение порядкового номера в корзине
- `buttonDelCard: HTMLButtonElement` - иконка корзины, по клику на которую удаляется соответствующая карточка.

Параметры в конструкторе:

параметры класса `Card`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `set index(value: number): void` - записывает порядковый номер карточки в корзине.

#### Класс Page
Расширяет класс View. За основной контейнер берет главную страницу приложения. Служит для отображения корзины в шапке сайта и количества товаров в ней, также служит для отображения основного блока с кталогом карточек товаров.

Поля:

- `protected _catalog: HTMLElement` - контейнер для отображения карточек товаров
- `protected buttonBasket: HTMLButtonElement` - иконка(кнопка), по нажатию на которую открывается модальное окно с корзиной
- `protected _counter: HTMLSpanElement` - html элемент, показывающий количество добавленных товаров в корзину
- `protected screen: HTMLDivElement` - html элемент, отвечающий за внутренннее содержимое страницы(экран).

Параметры в конструкторе:

параметры класса `View`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `set catalog(cards: HTMLElement[]): void` - записывает карточки в _catalog для отображения их на главной странице
- `set counter(value: string): void` - записывает количество добавленных товаров в корзину
- `lockScreen(value: boolean): void` - данный метод служит для блокировки/разблокировки экрана(окна), чтоб не было его прокрутки при открытии/закрытии модального окна.

#### Класс Basket
Расширяет класс View. Отображает модальное окно корзины с добавленными в нее товарами.

Поля

- `protected _cardsList: HTMLUListElement` - html элемент, отвечающий за отображение списка карточек в корзине
- `protected _total: HTMLSpanElement` - html элемент, отвечающий за отображение общей стоимости товаров
- `protected buttonСheckout: HTMLButtonElement` - кнопка "Оформить".

Параметры в конструкторе:

параметры класса `View`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `set cardsList(cards: HTMLElement[]): void` - устанавливает список карточек добавленных товаров в корзину
- `set emptyCheck(state: boolean): void` - для блокировки кнопки "Оформить", если корзина пуста
- `set total(value: number)` - устанавливает общую стоимость товаров в html элемент _totalPrice.

#### Класс Modal
Расширяет класс View. Реализует модальное окно. Устанавливает слушатели на клик в оверлей и кнопку-крестик для закрытия попапа.

Поля:

- `protected _content: HTMLElement` - содержимое модального окна
- `protected buttonClose: HTMLButtonElement` - кнопка закрытия модального окна.

Параметры в конструкторе:

параметры `View`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `set content(value: HTMLElement): void` - для возможности изменения внутреннего содержимого модального окна
- `open(): void` - метод отображения модального окна
- `close(): void` - метод для закрытия модального окна.

#### Класс Form
Расширяет класс View. Является абстрактным классом дженериком и шаблоном для форм приложения. Реализует пользовательский функционал с формами.

Поля:

- `protected container: HTMLFormElement` - соответствующая форма
- `protected inputsList: HTMLInputElement[]` - массив input элементов формы
- `protected submitButton: HTMLButtonElement` - кнопка отправки формы
- `protected _errorMessage: HTMLSpanElement` - html элемент для отображения ошибок формы.
Параметры в конструкторе:

параметры `View`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `get valid(): boolean` - получения статуса валидности формы
- `set valid(value: boolean):void` - сеттер для блокировки (true) / разблокировки (false) кнопки submit
- `set errorMessage(value: string)` - установка текста ошибок
- `clear():void` - очистка формы при её закрытии
- `render(data: Partial<T> & TForm ): HTMLElement` - модернизированный render View для форм: учитывает установку обязательных полей valid и errorMessage.

#### Класс FormOrder
Расширяет класс Form. Первое окно при оформлении заказа. Форма для указания способа оплаты и адреса доставки.

Поля:

- `protected containerButtons: HTMLDivElement` - контейнер, содержащий кнопки "онлайн" и "при получении"
- `protected buttonCard: HTMLButtonElement` - кнопка "онлайн"
- `protected buttonCash: HTMLButtonElement` - кнопка "при получении"
- `protected inputAddress: HTMLInputElement` - поле для ввода адреса покупателя.

Параметры в конструкторе:

параметры `Form`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `protected getButtonActive(): HTMLButtonElement | null` - служебный метод: возвращает кнопку, которая активна, либо null, если нет активной кнопки
- `protected resetButtons(): void` - служебный метод: очищает класс активности с кнопок "Онлайн" и "При получении"
- `clear(): void` - Очищает форму и снимает класс активности с кнопок
- `get payment(): TPayment | null` - возвращает имя активной кнопки (нужно для записи способа покупки), либо null
- `get address(): string` - возвращает адрес покупателя
- `get valid(): boolean` - возвращает валидность формы. В данном случае форма валидна, если была нажата одна из кнопок и в поле ввода не пустое значение. Также записывается текст ошибки
`set valid(value: boolean):void` - запись для блокировки (true) / разблокировки (false) кнопки submit.

#### Класс FormContacts
Расширяет класс Form. Второе окно при оформлении заказа. Форма для указания телефона и email покупателя.

Поля

- `protected inputEmail: HTMLInputElement` - текстовое поле для email
- `protected inputPhone: HTMLInputElement` - текстовое поле для номера телефона.

Параметры в конструкторе:

параметры `Form`.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `get email(): string` - возвращает email из поля ввода email
- `get phone(): string` - возвращает номер телефона из поля ввода phone
- `get valid(): boolean` - возвращает валидность формы. В данном случае форма валидна, если все поля заполнены. Также записывается текст ошибки
- `set valid(value: boolean):void` - запись для блокировки (true) / разблокировки (false) кнопки submit.

#### Класс Success
Наследует класс View. Третье и последнее окно при оформлении заказа. Уведомление об успешной покупке, содержит кнопку закрытия "за новыми покупками!".

Поля

- `protected buttonOrderSuccess: HTMLButtonElement` - кнопка "За новыми покупками"
- `protected _totalSum: HTMLParagraphElement` - html элемент, отвечающий за показ потраченных средств за все покупки.

Параметры в конструкторе:

параметры `View`

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `set totalSum(total: string): void` - устанавливает количество потраченных средств в html элемент _description.

### Слой коммуникации

#### Класс AppApi

Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

Также в классе содержатся методы для работы с данными объекта, который формирует класс:

- `getProducts(): Promise<ICard[]>` - получает с сервера массив объектов всех товаров
- `getProductById(id: string): Promise<ICard>` - получает с сервера конкретный товар по id
- `postOrder(order: IOrder): Promise<TSuccessData>` - отправляет post запрос на сервер, содержащий данные о заказе и получает по итогу номер заказа (id) и общую сумму заказ (total).

## Взаимодействие компонентов - слой Presenter
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.
Взаимодействие осуществляется за счет событий, генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts` В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

Список событий, которые могут генерироваться в системе:

*События изменения данных (генерируются классами __моделями данных__):*
- `cards:changed` - изменение массива данных продуктов
- `purchases:changed` - изменение массива покупок(добавленные товары покупателем в корзину)
- `success:changed` - событие, возникающее при получении(изменении) данных успешного заказа.

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются __классами, отвечающими за представление__):*

- `modal:open` - событие, срабатывающее при открытии модального окна
- `modal:close` - событие, срабатывающее при закрытии модального окна
- `modal-card:open` - выбор карточки для отображения в модальном окне
- `modal-basket:open` - открытие модального окна для отображения корзины
- `purchases:add` - событие при добавлении товара в корзину покупателя
- `purchases:delete` - событие при удалении товара из корзины покупателя
- `basket:submit` - переход к оформлению товаров в корзине
- `modal-order:open` - открытие модального окна со способом оплаты
- `order:valid` - событие, возникающее при действиях покупателя с полями формы со способом оплаты
- `order:submit` - событие, возникающее при успешном прохождении формы оплаты и адреса
- `contacts:valid` - событие, возникающее при действиях покупателя с полями формы контактных данных
- `contacts:submit` - событие, возникающее при успешном прохождении формы контактных данных.
- `success: submit` - событие, возникающее при успешном оформлении заказа, а также возвращения к списку продуктов после успешного оформления заказа
